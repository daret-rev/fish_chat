{% extends 'base.html' %}
{% block title %}Админ – Список сообщений{% endblock %}
{% block content %}
<p><a href="{{ url_for('lesson_management') }}" class="btn">← назад</a></p>

<h2>Создание урока</h2>

<form id="lessonForm" method="post">
    <section>
        <div style="margin: 20px 0;">
          <input type="text" name="lesson_name" id="nemeLesson" placeholder="Название"
                 style="padding: 8px; width: 300px;">

          <p>
            <label for="time">Время на тест:</label>
            <input type="number" step="1" name="time" id="time" placeholder="мин"><br>
          </p>

        <p>
            <label for="price_correct">Цена за правильный ответ:</label>
            <input type="number" step="1" name="price_correct" id="price_correct" required><br>
        </p>

        <p>
            <label for="price_wrong">Цена за неправильный ответ:</label>
            <input type="number" step="1" name="price_wrong" id="price_wrong" required><br>
        </p>

        </div>
    </section>

    <h3>Укажите колтчество сообщений или выберете конкретные</h3>
    <p>
        <label for="msg_count">Количество:</label>
        <input type="number" step="1" name="msg_count" id="msg_count" placeholder="шт"><br>
    </p>
    <button type="button" onclick="prepareAndSubmit()">Создать</button>
    <h3>Список всех сообщений</h3>

    <!-- Фильтр поиска -->
    <div style="margin: 20px 0;">
      <input type="text" id="searchText" placeholder="Поиск по тексту..."
             style="padding: 8px; width: 300px;">

      <input type="text" id="searchID" placeholder="Поиск по ID..."
             style="padding: 8px; width: 100px; margin-left: 10px;">

      <select id="searchAnswer" style="padding: 8px; margin-left: 10px;">
        <option value="">Все ответы</option>
        <option value="Фейк">Фейк</option>
        <option value="Реальная">Реальная</option>
      </select>

      <button type="button" onclick="searchTable()" style="padding: 6px 16px; margin-left: 15px;">
        Найти
      </button>

      <button type="button" onclick="clearSearch()" style="padding: 6px 16px; margin-left: 10px;">
        Сбросить
      </button>
    </div>

  <input type="hidden" id="selectedIds" name="selected_ids" value="">

    <table border="1" cellpadding="5" id="messagesTable">
      <tr>
        <th>ID</th><th>Текст</th><th>Правильный ответ</th><th>Добавить</th>
      </tr>
      {% for m in messages %}
      <tr class="msg_row">
        <td>{{ m.id }}</td>
        <td>
          <div style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px;">
            {{ m.text }}
          </div>
        </td>
        <td>{% if m.correct %}Фейк{% else %}Реальная{% endif %}</td>
        <td>
          <div class="actions">
              <input type="checkbox" class="msg-checkbox" value="{{ m.id }}">
          </div>
        </td>
      </tr>
      {% endfor %}
    </table>
</form>



<script>
    function searchTable() {
      const searchText = document.getElementById('searchText').value.toLowerCase();
      const searchID = document.getElementById('searchID').value.toLowerCase();
      const searchAnswer = document.getElementById('searchAnswer').value;

      const rows = document.querySelectorAll('table tr.msg_row');

      rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (cells.length >= 3) {
          const id = cells[0].textContent.toLowerCase();
          const text = cells[1].textContent.toLowerCase();
          const answer = cells[2].textContent;

          let show = true;

          if (searchID && !id.includes(searchID)) show = false;
          if (searchText && !text.includes(searchText)) show = false;
          if (searchAnswer && answer !== searchAnswer) show = false;

          row.style.display = show ? '' : 'none';
        }
      });
    }

    function clearSearch() {
      document.getElementById('searchText').value = '';
      document.getElementById('searchID').value = '';
      document.getElementById('searchAnswer').value = '';

      const rows = document.querySelectorAll('tr.msg_row, tr.msg-row');
      rows.forEach(row => {
        row.style.display = '';
      });
    }

    function updateSelectedIds() {
      const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.value);
      document.getElementById('selectedIds').value = selectedIds.join(',');
      return selectedIds;
    }

    function submitForm(action) {
      const selectedIds = updateSelectedIds();

      if (selectedIds.length === 0) {
        alert('Выберите хотя бы одно сообщение');
        return;
      }

      const form = document.getElementById('lessonForm');
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = action;
      form.appendChild(actionInput);

      form.submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
      const checkboxes = document.querySelectorAll('.msg-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedIds);
      });
    });

    function prepareAndSubmit() {
      const lessonName = document.querySelector('input[name="lesson_name"]').value;
      const time = document.querySelector('input[name="time"]').value;
      const priceCorrect = document.querySelector('input[name="price_correct"]').value;
      const priceWrong = document.querySelector('input[name="price_wrong"]').value;
      const countMsg = document.querySelector('input[name="msg_count"]').value;


      if (!lessonName.trim()) {
        alert('Введите название урока');
        return;
      }

      const timeInput = document.getElementById('time');
      if (!timeInput.value.trim()) {
        timeInput.value = '';
      }

      if (!priceCorrect) {
        alert('Укажите цену за правильный ответ');
        return;
      }

      if (!priceWrong) {
        alert('Укажите цену за неправильный ответ');
        return;
      }

      const selectedIds = updateSelectedIds();

      if (selectedIds.length === 0 && !countMsg) {
        alert('Выберите сообщения для урока или укажите количество');
        return;
      }

      if (!(selectedIds.length === 0) && countMsg) {
        alert('Выберете только 1 способ отбора сообщений');
        return;
      }

      document.getElementById('lessonForm').submit();
    }
</script>
{% endblock %}
{% set show_footer = False %}