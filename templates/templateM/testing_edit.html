{% extends 'base.html' %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è{% endblock %}

{% block content %}
<section class="hero-section">
    <div class="container">
        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
        <div style="margin-bottom: 30px;">
            <a href="{{ url_for('testing_list') }}" style="text-decoration: none;">
                <button class="btn-left" style="padding: 8px 20px; font-size: 14px;">
                    ‚Üê –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–π
                </button>
            </a>
        </div>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 class="hero-title" style="margin-bottom: 15px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
            <p style="color: #6c757d; font-size: 1.1rem; max-width: 800px; margin: 0 auto;">
                –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: <strong>{{ testing.name }}</strong>
            </p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <div style="
            max-width: 1200px;
            margin: 0 auto 50px;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        ">
            <form id="testingForm" method="post">
                <input type="hidden" name="testing_id" value="{{ testing.id }}">

                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3rem;">‚öôÔ∏è</span>
                        –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    </h3>

                    <div style="
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 25px;
                        margin-bottom: 30px;
                    ">
                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="
                                        background-color: #007bff;
                                        color: white;
                                        width: 30px;
                                        height: 30px;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin-right: 10px;
                                        font-size: 1rem;
                                    ">
                                        1Ô∏è‚É£
                                    </div>
                                    –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
                                </div>
                            </label>
                            <input
                                type="text"
                                name="testing_name"
                                id="nemeTesting"
                                value="{{ testing.name }}"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
                                style="
                                    width: 100%;
                                    padding: 12px 15px;
                                    border: 1px solid #ced4da;
                                    border-radius: 8px;
                                    font-size: 1rem;
                                    transition: border-color 0.3s ease;
                                "
                                onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,.25)';"
                                onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none';"
                            >
                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            </small>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="
                                        background-color: #28a745;
                                        color: white;
                                        width: 30px;
                                        height: 30px;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin-right: 10px;
                                        font-size: 1rem;
                                    ">
                                        2Ô∏è‚É£
                                    </div>
                                    –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
                                </div>
                            </label>
                            <select
                                name="status"
                                id="status"
                                style="
                                    width: 100%;
                                    padding: 12px 15px;
                                    border: 1px solid #ced4da;
                                    border-radius: 8px;
                                    font-size: 1rem;
                                    background-color: white;
                                    transition: border-color 0.3s ease;
                                "
                                onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,.25)';"
                                onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none';"
                            >
                                <option value="active" {% if testing.status == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω–æ</option>
                                <option value="archived" {% if testing.status == 'archived' %}selected{% endif %}>–ê—Ä—Ö–∏–≤</option>
                            </select>
                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                "–ê–∫—Ç–∏–≤–Ω–æ" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                            </small>
                        </div>
                    </div>
                </div>

                <!-- –í—ã–±–æ—Ä —É—Ä–æ–∫–∞ -->
                <div style="margin-bottom: 40px;">
                    <div style="margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #6f42c1;">
                        <h3 style="color: #2c3e50; display: flex; align-items: center; gap: 10px; margin: 0;">
                            <span style="font-size: 1.3rem;">üìö</span>
                            –í—ã–±–æ—Ä —É—Ä–æ–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        </h3>
                        <p style="color: #6c757d; margin-top: 8px;">
                            –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω —É—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏. –í—ã–±—Ä–∞–Ω–æ: <span id="selectedLessonCount" style="font-weight: 600; color: #007bff;">{{ 1 if testing.lesson_id else 0 }}</span> —É—Ä–æ–∫–æ–≤
                        </p>
                    </div>

                    <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ —É—Ä–æ–∫–æ–≤ -->
                    <div style="
                        background-color: #f8f9fa;
                        border-radius: 10px;
                        padding: 20px;
                        margin-bottom: 25px;
                    ">
                        <h4 style="margin: 0 0 15px 0; color: #495057; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3rem;">üîç</span>
                            –ü–æ–∏—Å–∫ —É—Ä–æ–∫–æ–≤
                        </h4>
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin-bottom: 20px;
                        ">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 0.9rem;">
                                    –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é:
                                </label>
                                <input
                                    type="text"
                                    id="searchLessonName"
                                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞..."
                                    style="
                                        width: 100%;
                                        padding: 10px 15px;
                                        border: 1px solid #ced4da;
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                        transition: border-color 0.3s ease;
                                    "
                                    onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,.25)';"
                                    onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none';"
                                    onkeyup="searchLessons()"
                                >
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 0.9rem;">
                                    –ü–æ ID:
                                </label>
                                <input
                                    type="text"
                                    id="searchLessonID"
                                    placeholder="ID —É—Ä–æ–∫–∞..."
                                    style="
                                        width: 100%;
                                        padding: 10px 15px;
                                        border: 1px solid #ced4da;
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                        transition: border-color 0.3s ease;
                                    "
                                    onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,.25)';"
                                    onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none';"
                                    onkeyup="searchLessons()"
                                >
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button
                                type="button"
                                onclick="clearLessonSearch()"
                                style="
                                    padding: 10px 20px;
                                    background-color: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.3s ease;
                                "
                                onmouseover="this.style.backgroundColor='#5a6268'; this.style.transform='translateY(-2px)';"
                                onmouseout="this.style.backgroundColor='#6c757d'; this.style.transform='translateY(0)';"
                            >
                                <span style="font-size: 1.1rem;">üîÑ</span>
                                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </button>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–∫–æ–≤ -->
                    <div style="
                        background: white;
                        border-radius: 10px;
                        border: 1px solid #e9ecef;
                        overflow: hidden;
                        max-height: 300px;
                        overflow-y: auto;
                    ">
                        <div style="overflow-x: auto;">
                            <table style="
                                width: 100%;
                                border-collapse: collapse;
                                min-width: 800px;
                            ">
                                <thead>
                                    <tr style="
                                        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
                                        color: white;
                                    ">
                                        <th style="padding: 15px; text-align: left; font-weight: 600; border-radius: 8px 0 0 0; width: 60px;">–í—ã–±—Ä–∞—Ç—å</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600;">ID</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600;">–ë–∞–ª–ª—ã</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600; border-radius: 0 8px 0 0;">–ó–∞–¥–∞–Ω–∏–π</th>
                                    </tr>
                                </thead>
                                <tbody id="lessonsTableBody">
                                    {% for l in lessons %}
                                    <tr style="
                                        border-bottom: 1px solid #e9ecef;
                                        transition: all 0.3s ease;
                                    "
                                    class="lesson-select-row"
                                    onmouseover="this.style.backgroundColor='#f8f9fa';"
                                    onmouseout="this.style.backgroundColor='';">
                                        <td style="padding: 15px; vertical-align: top; text-align: center;">
                                            <label style="
                                                display: inline-block;
                                                cursor: pointer;
                                                position: relative;
                                            ">
                                                <input
                                                    type="radio"
                                                    name="lesson_id"
                                                    class="lesson-radio"
                                                    value="{{ l.id }}"
                                                    {% if testing.lesson_id == l.id %}checked{% endif %}
                                                    style="
                                                        width: 20px;
                                                        height: 20px;
                                                        cursor: pointer;
                                                    "
                                                >
                                            </label>
                                        </td>
                                        <td style="padding: 15px; font-weight: 600; color: #495057; vertical-align: top;">
                                            #{{ l.id }}
                                        </td>
                                        <td style="padding: 15px; vertical-align: top;">
                                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">
                                                {{ l.name }}
                                            </div>
                                        </td>
                                        <td style="padding: 15px; vertical-align: top;">
                                            <div style="display: flex; gap: 10px; font-size: 0.85rem;">
                                                <div>
                                                    <span style="color: #28a745; font-weight: 600;">+{{ l.price_correct }}</span>
                                                </div>
                                                <div>
                                                    <span style="color: #dc3545; font-weight: 600;">{{ l.price_wrong }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="padding: 15px; vertical-align: top;">
                                            <div style="
                                                display: inline-flex;
                                                align-items: center;
                                                padding: 6px 12px;
                                                border-radius: 20px;
                                                font-weight: 600;
                                                font-size: 0.85rem;
                                                background-color: {% if l.questions|length >= 20 %}#d4edda{% elif l.questions|length >= 10 %}#fff3cd{% else %}#f8d7da{% endif %};
                                                color: {% if l.questions|length >= 20 %}#155724{% elif l.questions|length >= 10 %}#856404{% else %}#721c24{% endif %};
                                                gap: 6px;
                                            ">
                                                <span style="font-size: 0.9rem;">üìã</span>
                                                {{ l.questions|length }}
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" style="padding: 40px; text-align: center; color: #6c757d;">
                                            <div style="font-size: 2rem; margin-bottom: 20px;">üì≠</div>
                                            <h3 style="margin-bottom: 10px; color: #495057;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</h3>
                                            <p style="margin-bottom: 20px;">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —É—Ä–æ–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</p>
                                            <a href="{{ url_for('lesson_create') }}" style="text-decoration: none;">
                                                <button style="
                                                    padding: 10px 20px;
                                                    background-color: #28a745;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 6px;
                                                    cursor: pointer;
                                                    font-weight: 600;
                                                ">
                                                    ‚ûï –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫
                                                </button>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- –í—ã–±–æ—Ä –≥—Ä—É–ø–ø -->
                <div style="margin-bottom: 40px;">
                    <div style="margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                        <h3 style="color: #2c3e50; display: flex; align-items: center; gap: 10px; margin: 0;">
                            <span style="font-size: 1.3rem;">üë•</span>
                            –í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        </h3>
                        <p style="color: #6c757d; margin-top: 8px;">
                            –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é. –í—ã–±—Ä–∞–Ω–æ: <span id="selectedGroupCount" style="font-weight: 600; color: #007bff;">{{ group_ids|length }}</span> –≥—Ä—É–ø–ø
                        </p>
                    </div>

                    <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –≥—Ä—É–ø–ø -->
                    <div style="
                        background-color: #f8f9fa;
                        border-radius: 10px;
                        padding: 20px;
                        margin-bottom: 25px;
                    ">
                        <h4 style="margin: 0 0 15px 0; color: #495057; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3rem;">üîç</span>
                            –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø
                        </h4>
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin-bottom: 20px;
                        ">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 0.9rem;">
                                    –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é:
                                </label>
                                <input
                                    type="text"
                                    id="searchGroupName"
                                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..."
                                    style="
                                        width: 100%;
                                        padding: 10px 15px;
                                        border: 1px solid #ced4da;
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                        transition: border-color 0.3s ease;
                                    "
                                    onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,.25)';"
                                    onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none';"
                                    onkeyup="searchGroups()"
                                >
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 0.9rem;">
                                    –ü–æ ID:
                                </label>
                                <input
                                    type="text"
                                    id="searchGroupID"
                                    placeholder="ID –≥—Ä—É–ø–ø—ã..."
                                    style="
                                        width: 100%;
                                        padding: 10px 15px;
                                        border: 1px solid #ced4da;
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                        transition: border-color 0.3s ease;
                                    "
                                    onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,.25)';"
                                    onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none';"
                                    onkeyup="searchGroups()"
                                >
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button
                                type="button"
                                onclick="clearGroupSearch()"
                                style="
                                    padding: 10px 20px;
                                    background-color: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.3s ease;
                                "
                                onmouseover="this.style.backgroundColor='#5a6268'; this.style.transform='translateY(-2px)';"
                                onmouseout="this.style.backgroundColor='#6c757d'; this.style.transform='translateY(0)';"
                            >
                                <span style="font-size: 1.1rem;">üîÑ</span>
                                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </button>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ –≥—Ä—É–ø–ø -->
                    <div style="
                        background: white;
                        border-radius: 10px;
                        border: 1px solid #e9ecef;
                        overflow: hidden;
                        max-height: 300px;
                        overflow-y: auto;
                    ">
                        <div style="overflow-x: auto;">
                            <table style="
                                width: 100%;
                                border-collapse: collapse;
                                min-width: 800px;
                            ">
                                <thead>
                                    <tr style="
                                        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                                        color: white;
                                    ">
                                        <th style="padding: 15px; text-align: left; font-weight: 600; border-radius: 8px 0 0 0; width: 60px;">–í—ã–±—Ä–∞—Ç—å</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600;">ID</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600; border-radius: 0 8px 0 0;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody id="groupsTableBody">
                                    {% for g in groups %}
                                    <tr style="
                                        border-bottom: 1px solid #e9ecef;
                                        transition: all 0.3s ease;
                                    "
                                    class="group-select-row"
                                    onmouseover="this.style.backgroundColor='#f8f9fa';"
                                    onmouseout="this.style.backgroundColor='';">
                                        <td style="padding: 15px; vertical-align: top; text-align: center;">
                                            <label style="
                                                display: inline-block;
                                                cursor: pointer;
                                                position: relative;
                                            ">
                                                <input
                                                    type="checkbox"
                                                    class="group-checkbox"
                                                    value="{{ g.id }}"
                                                    {% if g.id in group_ids %}checked{% endif %}
                                                    style="
                                                        width: 20px;
                                                        height: 20px;
                                                        cursor: pointer;
                                                    "
                                                >
                                            </label>
                                        </td>
                                        <td style="padding: 15px; font-weight: 600; color: #495057; vertical-align: top;">
                                            #{{ g.id }}
                                        </td>
                                        <td style="padding: 15px; vertical-align: top;">
                                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">
                                                {{ g.groupname }}
                                            </div>
                                        </td>
                                        <td style="padding: 15px; vertical-align: top;">
                                            <div style="
                                                display: inline-flex;
                                                align-items: center;
                                                padding: 6px 12px;
                                                border-radius: 20px;
                                                font-weight: 600;
                                                font-size: 0.85rem;
                                                background-color: {% if g.users|length >= 20 %}#d4edda{% elif g.users|length >= 10 %}#fff3cd{% else %}#f8d7da{% endif %};
                                                color: {% if g.users|length >= 20 %}#155724{% elif g.users|length >= 10 %}#856404{% else %}#721c24{% endif %};
                                                gap: 6px;
                                            ">
                                                <span style="font-size: 0.9rem;">üë•</span>
                                                {{ g.users|length }}
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" style="padding: 40px; text-align: center; color: #6c757d;">
                                            <div style="font-size: 2rem; margin-bottom: 20px;">üë•</div>
                                            <h3 style="margin-bottom: 10px; color: #495057;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø</h3>
                                            <p style="margin-bottom: 20px;">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                                            <a href="{{ url_for('group_create') }}" style="text-decoration: none;">
                                                <button style="
                                                    padding: 10px 20px;
                                                    background-color: #28a745;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 6px;
                                                    cursor: pointer;
                                                    font-weight: 600;
                                                ">
                                                    ‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                                                </button>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
                <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e9ecef; margin-bottom: 20px;">
                    <button
                        type="button"
                        onclick="prepareAndSubmit()"
                        style="
                            padding: 14px 40px;
                            font-size: 16px;
                            font-weight: 600;
                            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 10px;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 15px rgba(0,123,255,0.3)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                    >
                        <span style="font-size: 1.2rem;">üíæ</span>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </form>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div style="
            max-width: 1200px;
            margin: 0 auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #17a2b8;
        ">
            <div style="display: flex; align-items: flex-start;">
                <div style="
                    background-color: #17a2b8;
                    color: white;
                    width: 45px;
                    height: 45px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 15px;
                    flex-shrink: 0;
                    font-size: 1.3rem;
                ">
                    üí°
                </div>
                <div>
                    <h3 style="margin: 0 0 10px 0; color: #2c3e50;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                        <li>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–π</li>
                        <li>–ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ "–ê–∫—Ç–∏–≤–Ω–æ" –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</li>
                        <li>–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É—Ä–æ–∫, –≤—ã–±—Ä–∞–≤ –¥—Ä—É–≥–æ–π –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö</li>
                        <li>–î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –Ω—É–∂–Ω—ã—Ö —É—Ä–æ–∫–æ–≤ –∏ –≥—Ä—É–ø–ø</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // –°—á–µ—Ç—á–∏–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function updateSelectedCounts() {
        // –°—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤
        const selectedLesson = document.querySelectorAll('.lesson-radio:checked').length;
        document.getElementById('selectedLessonCount').textContent = selectedLesson;
        document.getElementById('selectedLessonCount').style.color = selectedLesson > 0 ? '#28a745' : '#007bff';

        // –°—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø
        const selectedGroups = document.querySelectorAll('.group-checkbox:checked').length;
        document.getElementById('selectedGroupCount').textContent = selectedGroups;
        document.getElementById('selectedGroupCount').style.color = selectedGroups > 0 ? '#28a745' : '#007bff';
    }

    // –ü–æ–∏—Å–∫ —É—Ä–æ–∫–æ–≤
    function searchLessons() {
        const searchName = document.getElementById('searchLessonName').value.toLowerCase();
        const searchID = document.getElementById('searchLessonID').value.toLowerCase();
        const rows = document.querySelectorAll('#lessonsTableBody .lesson-select-row');

        rows.forEach(row => {
            const cells = row.getElementsByTagName('td');
            if (cells.length >= 4) {
                const id = cells[1].textContent.toLowerCase().replace('#', '').trim();
                const name = cells[2].textContent.toLowerCase();
                let show = true;

                if (searchID && !id.includes(searchID)) show = false;
                if (searchName && !name.includes(searchName)) show = false;

                row.style.display = show ? '' : 'none';
                row.style.opacity = show ? '1' : '0.5';
            }
        });
    }

    function clearLessonSearch() {
        document.getElementById('searchLessonName').value = '';
        document.getElementById('searchLessonID').value = '';
        const rows = document.querySelectorAll('#lessonsTableBody .lesson-select-row');
        rows.forEach(row => {
            row.style.display = '';
            row.style.opacity = '1';
        });
    }

    // –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø
    function searchGroups() {
        const searchName = document.getElementById('searchGroupName').value.toLowerCase();
        const searchID = document.getElementById('searchGroupID').value.toLowerCase();
        const rows = document.querySelectorAll('#groupsTableBody .group-select-row');

        rows.forEach(row => {
            const cells = row.getElementsByTagName('td');
            if (cells.length >= 4) {
                const id = cells[1].textContent.toLowerCase().replace('#', '').trim();
                const name = cells[2].textContent.toLowerCase();
                let show = true;

                if (searchID && !id.includes(searchID)) show = false;
                if (searchName && !name.includes(searchName)) show = false;

                row.style.display = show ? '' : 'none';
                row.style.opacity = show ? '1' : '0.5';
            }
        });
    }

    function clearGroupSearch() {
        document.getElementById('searchGroupName').value = '';
        document.getElementById('searchGroupID').value = '';
        const rows = document.querySelectorAll('#groupsTableBody .group-select-row');
        rows.forEach(row => {
            row.style.display = '';
            row.style.opacity = '1';
        });
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    function prepareAndSubmit() {
        const testingName = document.querySelector('input[name="testing_name"]').value.trim();

        if (!testingName) {
            showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        const testing_names = {{ testing_names|tojson|safe }};

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        const currentTestingName = "{{ testing.name }}";
        const filteredNames = testing_names.filter(name => name !== currentTestingName);

        if (filteredNames.includes(testingName)) {
            showError('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.');
            return;
        }

        const selectedLesson = document.querySelector('input[name="lesson_id"]:checked');
        if (!selectedLesson) {
            showError('–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        const selectedGroups = document.querySelectorAll('.group-checkbox:checked');
        if (selectedGroups.length === 0) {
            showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        const groupIds = Array.from(selectedGroups).map(cb => cb.value).join(',');

        const existingHidden = document.querySelector('input[name="group_ids"]');
        if (existingHidden) {
            existingHidden.remove();
        }

        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'group_ids';
        hiddenInput.value = groupIds;

        const form = document.getElementById('testingForm');
        form.appendChild(hiddenInput);
        form.submit();
    }

    // –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫
    function showError(message) {
        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        const existingAlert = document.querySelector('.alert-error');
        if (existingAlert) {
            existingAlert.remove();
        }

        // –°–æ–∑–¥–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert-error';
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.backgroundColor = '#dc3545';
        alertDiv.style.color = 'white';
        alertDiv.style.padding = '15px 20px';
        alertDiv.style.borderRadius = '8px';
        alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        alertDiv.style.zIndex = '1000';
        alertDiv.style.display = 'flex';
        alertDiv.style.alignItems = 'center';
        alertDiv.style.gap = '10px';
        alertDiv.style.maxWidth = '400px';
        alertDiv.innerHTML = `
            <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
            <div>
                <strong>–û—à–∏–±–∫–∞!</strong><br>
                <span style="font-size: 0.9rem;">${message}</span>
            </div>
            <button onclick="this.parentElement.remove()" style="
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                margin-left: auto;
                padding: 0;
            ">√ó</button>
        `;

        document.body.appendChild(alertDiv);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
        const lessonRadios = document.querySelectorAll('.lesson-radio');
        lessonRadios.forEach(radio => {
            radio.addEventListener('change', updateSelectedCounts);
        });

        const groupCheckboxes = document.querySelectorAll('.group-checkbox');
        groupCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCounts);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        updateSelectedCounts();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        const searchInputs = ['searchLessonName', 'searchLessonID', 'searchGroupName', 'searchGroupID'];
        searchInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function() {
                    if (id.includes('Lesson')) searchLessons();
                    if (id.includes('Group')) searchGroups();
                });
            }
        });
    });
</script>
{% endblock %}
{% set show_footer = False %}