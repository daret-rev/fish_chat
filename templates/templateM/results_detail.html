{% extends 'base.html' %}
{% block title %}–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - {{ test.name }}{% endblock %}

{% block content %}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .detailed-stats-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .back-btn-container {
        margin-bottom: 30px;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .back-btn:hover {
        background: #e9ecef;
        transform: translateX(-5px);
    }

    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f1f3f5;
    }

    .stats-title {
        margin: 0;
        color: #2c3e50;
        font-size: 1.8rem;
    }

    .stats-id {
        background: #6f42c1;
        color: white;
        padding: 6px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .chart-wrapper {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
        position: relative;
    }

    .chart-title {
        margin: 0 0 20px 0;
        color: #495057;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-scroll-container {
        width: 100%;
        overflow-x: auto;
        position: relative;
        padding-bottom: 10px;
    }

    .chart-inner {
        min-width: 800px;
        height: 400px;
        position: relative;
    }

    /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
    .chart-scroll-container::-webkit-scrollbar {
        height: 8px;
    }

    .chart-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .chart-scroll-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .chart-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .mode-switcher {
        display: flex;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 25px;
        width: fit-content;
        border: 1px solid #dee2e6;
    }

    .mode-btn {
        padding: 10px 25px;
        border: none;
        background: none;
        border-radius: 8px;
        font-weight: 600;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .mode-btn.active {
        background: white;
        color: #6f42c1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .mode-btn:hover:not(.active) {
        background: #e9ecef;
    }

    .filters-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .filters-title {
        margin: 0 0 15px 0;
        color: #495057;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .filter-input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .filter-input:focus {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111,66,193,.25);
        outline: none;
    }

    .filter-select {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        font-size: 0.95rem;
        background: white;
        transition: all 0.3s ease;
    }

    .filter-select:focus {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111,66,193,.25);
        outline: none;
    }

    .filter-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .filter-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-btn.reset {
        background: #6c757d;
        color: white;
    }

    .filter-btn.reset:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .data-table th {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        color: white;
        font-weight: 600;
        padding: 16px;
        text-align: left;
        position: sticky;
        top: 0;
    }

    .data-table th:first-child {
        border-radius: 12px 0 0 0;
    }

    .data-table th:last-child {
        border-radius: 0 12px 0 0;
    }

    .data-table td {
        padding: 16px;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.3s ease;
        word-break: break-word;
        vertical-align: middle;
    }

    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .clickable-row {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .clickable-row:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .user-score {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.95rem;
        min-width: 60px;
        text-align: center;
    }

    .user-score.good {
        background: #d4edda;
        color: #155724;
    }

    .user-score.medium {
        background: #fff3cd;
        color: #856404;
    }

    .user-score.poor {
        background: #f8d7da;
        color: #721c24;
    }

    .progress-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .progress-value {
        font-weight: 600;
        color: #495057;
        min-width: 50px;
    }

    .progress-bar {
        flex: 1;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .no-data {
        text-align: center;
        padding: 50px !important;
        color: #6c757d;
    }

    .no-data-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .table-scroll {
        max-height: 600px;
        overflow-y: auto;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" —Å –≥—Ä—É–ø–ø–∞–º–∏ */
    .groups-details-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #6f42c1;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
    }

    .groups-details-btn:hover {
        background: #5a32a3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(111,66,193,0.3);
    }

    .groups-details-btn .badge {
        background: white;
        color: #6f42c1;
        font-size: 0.75rem;
        padding: 1px 6px;
        border-radius: 10px;
        font-weight: 700;
    }

    .groups-tooltip {
        position: absolute;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 200px;
        max-width: 300px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }

    .groups-tooltip.active {
        display: block;
    }

    .groups-tooltip-header {
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
    }

    .groups-tooltip-title {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .groups-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .group-list-item {
        padding: 8px 10px;
        margin: 4px 0;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.85rem;
        color: #495057;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .group-list-item:hover {
        background: #e9ecef;
    }

    .group-list-item::before {
        content: "üè∑Ô∏è";
        font-size: 0.9rem;
    }

    .single-group {
        background: #f1f3f5;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #495057;
        display: inline-block;
    }

    /* –¶–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ */
    .progress-fill.high {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }

    .progress-fill.medium {
        background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
    }

    .progress-fill.low {
        background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1200px) {
        .detailed-stats-container {
            padding: 15px;
        }

        .filter-group {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .stats-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .filter-group {
            grid-template-columns: 1fr;
        }

        .mode-switcher {
            width: 100%;
            justify-content: center;
        }

        .mode-btn {
            flex: 1;
            justify-content: center;
        }

        .data-table {
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 12px 10px;
        }

        .chart-inner {
            min-width: 600px;
            height: 350px;
        }
    }
</style>

<div class="detailed-stats-container">
    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
    <div class="back-btn-container">
        <a href="{{ url_for('result_list') }}" class="back-btn">
            <span style="font-size: 1.2rem;">‚Üê</span>
            –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–π
        </a>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="stats-header">
        <h1 class="stats-title">
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {{ test.name }}
        </h1>
        <div class="stats-id">
            ID: #{{ test.id }}
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º -->
    <div class="chart-wrapper">
        <h3 class="chart-title">
            <span style="font-size: 1.5rem;">üìà</span>
            –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
            <span id="chartCount" style="font-size: 0.9rem; color: #6c757d; margin-left: 10px;">
                (–ø–æ–∫–∞–∑–∞–Ω–æ: {{ users_data|length if currentMode == 'users' else groups_data|length }})
            </span>
        </h3>
        <div class="chart-scroll-container">
            <div class="chart-inner">
                <canvas id="detailedChartCanvas"></canvas>
            </div>
        </div>
        <div style="text-align: center; margin-top: 10px; color: #6c757d; font-size: 0.85rem;">
            <span style="display: inline-flex; align-items: center; gap: 5px;">
                <span>‚ÜîÔ∏è</span> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            </span>
        </div>
    </div>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ -->
    <div class="mode-switcher">
        <button class="mode-btn active" onclick="switchMode('users')">
            <span style="font-size: 1.1rem;">üë•</span>
            –£—á–∞—Å—Ç–Ω–∏–∫–∏
            <span id="usersCountBadge" style="background: #6f42c1; color: white; padding: 1px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px;">
                {{ users_data|length }}
            </span>
        </button>
        <button class="mode-btn" onclick="switchMode('groups')">
            <span style="font-size: 1.1rem;">üè¢</span>
            –ì—Ä—É–ø–ø—ã
            <span id="groupsCountBadge" style="background: #6f42c1; color: white; padding: 1px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px;">
                {{ groups_data|length }}
            </span>
        </button>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <div id="usersFilters" class="filters-container">
        <h4 class="filters-title">
            <span style="font-size: 1.1rem;">üîç</span>
            –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        </h4>
        <div class="filter-group">
            <div>
                <input type="text" id="userSearchName" class="filter-input"
                       placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞..." onkeyup="applyFilters()">
            </div>
            <div>
                <input type="text" id="userSearchGroup" class="filter-input"
                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..." onkeyup="applyFilters()">
            </div>
            <div>
                <select id="userSortSelect" class="filter-select" onchange="applyFilters()">
                    <option value="name">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –∏–º–µ–Ω–∏</option>
                    <option value="group">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –≥—Ä—É–ø–ø–µ</option>
                    <option value="accuracy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏</option>
                    <option value="score">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –±–∞–ª–ª–∞–º</option>
                    <option value="total_questions">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º</option>
                    <option value="correct">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset" onclick="clearFilters()">
                <span style="font-size: 1rem;">üîÑ</span>
                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä—É–ø–ø -->
    <div id="groupsFilters" class="filters-container" style="display: none;">
        <h4 class="filters-title">
            <span style="font-size: 1.1rem;">üîç</span>
            –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≥—Ä—É–ø–ø
        </h4>
        <div class="filter-group">
            <div>
                <input type="text" id="groupSearchName" class="filter-input"
                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..." onkeyup="applyFilters()">
            </div>
            <div>
                <select id="groupSortSelect" class="filter-select" onchange="applyFilters()">
                    <option value="name">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                    <option value="accuracy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏</option>
                    <option value="avg_score">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É</option>
                    <option value="total_score">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ —Å—É–º–º–µ –±–∞–ª–ª–æ–≤</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset" onclick="clearFilters()">
                <span style="font-size: 1rem;">üîÑ</span>
                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <div class="table-container">
        <div class="table-scroll">
            <table class="data-table" id="detailedUsersTable">
                <thead>
                    <tr>
                        <th style="width: 20%">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                        <th style="width: 17%">–ì—Ä—É–ø–ø—ã</th>
                        <th style="width: 10%">–í–æ–ø—Ä–æ—Å—ã</th>
                        <th style="width: 10%">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</th>
                        <th style="width: 20%">–¢–æ—á–Ω–æ—Å—Ç—å</th>
                        <th style="width: 10%">–ë–∞–ª–ª—ã</th>
                    </tr>
                </thead>
                <tbody id="detailedUsersBody">
                    {% for user in users_data %}
                    {% set user_groups = user.groups if user.groups is defined else [] %}
                    {% if user.group_names is defined %}
                        {% set user_groups = user.group_names %}
                    {% elif user.group_name is defined and user.group_name %}
                        {% set user_groups = [user.group_name] %}
                    {% endif %}

                    <tr class="clickable-row" data-user-id="{{ user.id }}" data-testing-id="{{ test.id }}"
                         data-groups="{{ user_groups|tojson|safe }}">
                        <td>
                            <strong style="color: #2c3e50;">{{ user.username }}</strong>
                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                                ID: {{ user.id }}
                            </div>
                        </td>
                        <td>
                            <div class="groups-cell-container" style="position: relative;">
                                {% if user_groups|length == 0 %}
                                    <span class="single-group" style="color: #6c757d; font-style: italic;">
                                        –ù–µ—Ç –≥—Ä—É–ø–ø—ã
                                    </span>
                                {% elif user_groups|length == 1 %}
                                    <span class="single-group">
                                        {{ user_groups[0] }}
                                    </span>
                                {% else %}
                                    <button type="button" class="groups-details-btn"
                                            data-groups='{{ user_groups|tojson|safe }}'
                                            onmouseenter="showGroupsTooltip(event, this)"
                                            onmouseleave="hideGroupsTooltip()">
                                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        <span class="badge">{{ user_groups|length }}</span>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                        <td style="text-align: center; font-weight: 600; font-size: 1.1rem;">
                            {{ user.total_questions }}
                        </td>
                        <td style="text-align: center;">
                            <span style="display: inline-block; padding: 4px 10px; background: #d4edda; color: #155724; border-radius: 4px; font-weight: 600;">
                                {{ user.correct }}
                            </span>
                        </td>
                        <td>
                            <div class="progress-container">
                                <span class="progress-value">{{ "%.1f"|format(user.accuracy) }}%</span>
                                <div class="progress-bar">
                                    <div class="progress-fill
                                        {% if user.accuracy >= 80 %}high
                                        {% elif user.accuracy >= 60 %}medium
                                        {% else %}low{% endif %}"
                                        style="width: {{ user.accuracy }}%">
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <span class="user-score
                                {% if user.score >= 80 %}good
                                {% elif user.score >= 60 %}medium
                                {% else %}poor{% endif %}">
                                {{ user.score }}
                            </span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="no-data">
                            <div class="no-data-icon">üì≠</div>
                            <h4 style="margin: 10px 0; color: #495057;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</h4>
                            <p style="margin: 0;">–í —ç—Ç–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –≥—Ä—É–ø–ø -->
    <div class="table-container" id="detailedGroupsTable" style="display: none; margin-top: 30px;">
        <div class="table-scroll">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 25%">–ì—Ä—É–ø–ø–∞</th>
                        <th style="width: 12%">–í—Å–µ–≥–æ</th>
                        <th style="width: 12%">–ü—Ä–æ—à–ª–∏</th>
                        <th style="width: 15%">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                        <th style="width: 20%">–¢–æ—á–Ω–æ—Å—Ç—å</th>
                        <th style="width: 16%">–°—É–º–º–∞ –±–∞–ª–ª–æ–≤</th>
                    </tr>
                </thead>
                <tbody id="detailedGroupsBody">
                    {% for group in groups_data %}
                    <tr>
                        <td>
                            <strong style="color: #2c3e50;">{{ group.name }}</strong>
                        </td>
                        <td style="text-align: center; font-weight: 600; font-size: 1.1rem;">
                            {{ group.total_users }}
                        </td>
                        <td style="text-align: center;">
                            <span style="display: inline-block; padding: 4px 10px; background: #d1ecf1; color: #0c5460; border-radius: 4px; font-weight: 600;">
                                {{ group.completed_users }}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <span class="user-score
                                {% if group.avg_score >= 80 %}good
                                {% elif group.avg_score >= 60 %}medium
                                {% else %}poor{% endif %}">
                                {{ "%.1f"|format(group.avg_score) }}
                            </span>
                        </td>
                        <td>
                            <div class="progress-container">
                                <span class="progress-value">{{ "%.1f"|format(group.accuracy) }}%</span>
                                <div class="progress-bar">
                                    <div class="progress-fill
                                        {% if group.accuracy >= 80 %}high
                                        {% elif group.accuracy >= 60 %}medium
                                        {% else %}low{% endif %}"
                                        style="width: {{ group.accuracy }}%">
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center; font-weight: 700; color: #6f42c1; font-size: 1.1rem;">
                            {{ group.total_score }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="no-data">
                            <div class="no-data-icon">üè¢</div>
                            <h4 style="margin: 10px 0; color: #495057;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≥—Ä—É–ø–ø–∞–º</h4>
                            <p style="margin: 0;">–î–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≥—Ä—É–ø–ø—ã</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Tooltip –¥–ª—è –≥—Ä—É–ø–ø -->
<div id="groupsTooltip" class="groups-tooltip"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let detailedChart = null;
    let currentMode = 'users';
    let originalUsersData = [];
    let originalGroupsData = [];
    let tooltipTimer = null;

    document.addEventListener('DOMContentLoaded', function() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        originalUsersData = Array.from(document.querySelectorAll('#detailedUsersBody tr.clickable-row'));
        originalGroupsData = Array.from(document.querySelectorAll('#detailedGroupsBody tr:not(.no-data)'));

        createChart();
        updateCounters();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Å—Ç—Ä–æ–∫–∞–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        document.addEventListener('click', function(e) {
            const row = e.target.closest('.clickable-row');
            if (row && !e.target.closest('.groups-details-btn')) {
                const userId = row.getAttribute('data-user-id');
                const testingId = row.getAttribute('data-testing-id');

                // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è
                row.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    row.style.transform = '';
                }, 150);

                // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    window.location.href = `/dashboard/testing_management/user_results/${testingId}/${userId}`;
                }, 200);
            }
        });

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.groups-details-btn') && !e.target.closest('#groupsTooltip')) {
                hideGroupsTooltip();
            }
        });
    });

    function showGroupsTooltip(event, button) {
        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        if (tooltipTimer) clearTimeout(tooltipTimer);

        // –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—ã –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
        let groups = [];
        try {
            groups = JSON.parse(button.getAttribute('data-groups') || '[]');
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≥—Ä—É–ø–ø:', e);
        }

        // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç—É–ª—Ç–∏–ø–∞
        const tooltip = document.getElementById('groupsTooltip');
        let groupsHtml = '';

        if (Array.isArray(groups) && groups.length > 0) {
            groups.forEach(group => {
                if (group && group.trim() !== '') {
                    groupsHtml += `<li class="group-list-item">${group}</li>`;
                }
            });
        }

        if (!groupsHtml) {
            groupsHtml = '<li class="group-list-item" style="color: #6c757d; font-style: italic;">–ù–µ—Ç –≥—Ä—É–ø–ø</li>';
        }

        tooltip.innerHTML = `
            <div class="groups-tooltip-header">
                <div class="groups-tooltip-title">
                    <span>üè∑Ô∏è</span>
                    –ì—Ä—É–ø–ø—ã —É—á–∞—Å—Ç–Ω–∏–∫–∞ (${groups.length})
                </div>
            </div>
            <ul class="groups-list">
                ${groupsHtml}
            </ul>
        `;

        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ç—É–ª—Ç–∏–ø
        const rect = button.getBoundingClientRect();
        tooltip.style.left = `${rect.left}px`;
        tooltip.style.top = `${rect.bottom + 5}px`;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø
        tooltip.classList.add('active');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞
        tooltipTimer = setTimeout(() => {
            tooltip.addEventListener('mouseleave', () => hideGroupsTooltip());
        }, 100);
    }

    function hideGroupsTooltip() {
        const tooltip = document.getElementById('groupsTooltip');
        tooltip.classList.remove('active');
        if (tooltipTimer) {
            clearTimeout(tooltipTimer);
            tooltipTimer = null;
        }
    }

    function createChart() {
        const ctx = document.getElementById('detailedChartCanvas').getContext('2d');
        if (detailedChart) detailedChart.destroy();

        const chartData = getChartData();

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–∞–Ω–≤–∞—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const minWidth = 800;
        const itemWidth = 60; // –®–∏—Ä–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        const chartInner = document.querySelector('.chart-inner');
        const totalWidth = Math.max(minWidth, chartData.labels.length * itemWidth);
        chartInner.style.minWidth = totalWidth + 'px';

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–∏ Y
        const allScores = chartData.datasets[0].data;
        const minScore = allScores.length > 0 ? Math.min(...allScores) : 0;
        const maxScore = allScores.length > 0 ? Math.max(...allScores) : 0;
        const yMin = Math.max(0, Math.floor(minScore * 0.9));
        const yMax = Math.ceil(maxScore * 1.1);

        detailedChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${currentMode === 'groups' ? '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª' : '–ë–∞–ª–ª—ã'}: ${context.parsed.y}`,
                            title: (context) => {
                                const label = chartData.labels[context[0].dataIndex];
                                return label.length > 30 ? label.substring(0, 30) + '...' : label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: yMin,
                        max: yMax,
                        grid: { color: 'rgba(0,0,0,0.1)' },
                        ticks: { stepSize: Math.max(1, Math.ceil((yMax - yMin) / 10)) },
                        title: { display: true, text: '–ë–∞–ª–ª—ã', color: '#495057' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: { size: 11 },
                            callback: function(value, index) {
                                const label = this.getLabelForValue(value);
                                return label.length > 20 ? label.substring(0, 20) + '...' : label;
                            }
                        },
                        title: {
                            display: true,
                            text: currentMode === 'groups' ? '–ì—Ä—É–ø–ø—ã' : '–£—á–∞—Å—Ç–Ω–∏–∫–∏',
                            color: '#495057'
                        }
                    }
                }
            }
        });
    }

    function getChartData() {
        let labels = [], data = [], colors = [];
        const colorSchemes = {
            groups: [
                'rgba(111, 66, 193, 0.7)', 'rgba(153, 102, 255, 0.7)',
                'rgba(186, 104, 200, 0.7)', 'rgba(121, 134, 203, 0.7)',
                'rgba(79, 195, 247, 0.7)', 'rgba(129, 199, 132, 0.7)'
            ],
            users: [
                'rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)',
                'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
            ]
        };

        const tableId = currentMode === 'groups' ? '#detailedGroupsBody' : '#detailedUsersBody';
        const rows = document.querySelectorAll(`${tableId} tr:not(.no-data)`);

        rows.forEach((row, index) => {
            if (row.style.display !== 'none') {
                const cells = row.cells;
                if (cells.length > 0 && !row.querySelector('.no-data-icon')) {
                    const name = currentMode === 'groups'
                        ? cells[0].querySelector('strong').textContent
                        : cells[0].querySelector('strong').textContent;
                    const score = currentMode === 'groups'
                        ? parseFloat(cells[3].textContent) || 0
                        : parseFloat(cells[5].textContent) || 0;

                    labels.push(name);
                    data.push(score);
                    colors.push(colorSchemes[currentMode][index % colorSchemes[currentMode].length]);
                }
            }
        });

        if (labels.length === 0) {
            labels = ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];
            data = [0];
            colors = ['rgba(200, 200, 200, 0.7)'];
        }

        return {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.7', '1')),
                borderWidth: 1,
                borderRadius: 6,
                barPercentage: 0.7
            }]
        };
    }

    function switchMode(mode) {
        currentMode = mode;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.includes(mode === 'users' ? '–£—á–∞—Å—Ç–Ω–∏–∫–∏' : '–ì—Ä—É–ø–ø—ã'));
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏ —Ñ–∏–ª—å—Ç—Ä—ã
        document.getElementById('detailedUsersTable').parentElement.style.display = mode === 'users' ? 'block' : 'none';
        document.getElementById('detailedGroupsTable').style.display = mode === 'groups' ? 'block' : 'none';
        document.getElementById('usersFilters').style.display = mode === 'users' ? 'block' : 'none';
        document.getElementById('groupsFilters').style.display = mode === 'groups' ? 'block' : 'none';

        createChart();
        updateCounters();
    }

    function applyFilters() {
        if (currentMode === 'groups') applyGroupFilters();
        else applyUserFilters();
        createChart();
        updateCounters();
    }

    function applyGroupFilters() {
        const searchName = document.getElementById('groupSearchName').value.toLowerCase();
        const sortBy = document.getElementById('groupSortSelect').value;
        const tbody = document.getElementById('detailedGroupsBody');

        // –ë–µ—Ä–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let filtered = [...originalGroupsData].filter(row => {
            if (!searchName) return true;
            const name = row.cells[0].textContent.toLowerCase();
            return name.includes(searchName);
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filtered.sort((a, b) => {
            const getValue = (row, type) => {
                switch(type) {
                    case 'name': return row.cells[0].textContent.trim();
                    case 'accuracy': return parseFloat(row.cells[4].querySelector('.progress-value').textContent.replace('%', '')) || 0;
                    case 'avg_score': return parseFloat(row.cells[3].textContent) || 0;
                    case 'total_score': return parseFloat(row.cells[5].textContent) || 0;
                }
                return 0;
            };

            const aVal = getValue(a, sortBy);
            const bVal = getValue(b, sortBy);
            return sortBy === 'name' ? aVal.localeCompare(bVal) : bVal - aVal;
        });

        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        tbody.innerHTML = '';
        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="no-data">
                        <div class="no-data-icon">üîç</div>
                        <h4 style="margin: 10px 0; color: #495057;">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                        <p style="margin: 0;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞</p>
                    </td>
                </tr>
            `;
        } else {
            filtered.forEach(row => tbody.appendChild(row.cloneNode(true)));
        }
    }

    function applyUserFilters() {
        const searchName = document.getElementById('userSearchName').value.toLowerCase();
        const searchGroup = document.getElementById('userSearchGroup').value.toLowerCase();
        const sortBy = document.getElementById('userSortSelect').value;
        const tbody = document.getElementById('detailedUsersBody');

        // –ë–µ—Ä–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let filtered = [...originalUsersData].filter(row => {
            const name = row.cells[0].textContent.toLowerCase();
            const groupsAttr = row.getAttribute('data-groups') || '';
            const groups = groupsAttr.split('|||').map(g => g.trim().toLowerCase());

            const nameMatch = !searchName || name.includes(searchName);
            const groupMatch = !searchGroup || groups.some(group => group.includes(searchGroup));

            return nameMatch && groupMatch;
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filtered.sort((a, b) => {
            const getValue = (row, type) => {
                switch(type) {
                    case 'name': return row.cells[0].textContent.trim();
                    case 'group': {
                        const groups = row.getAttribute('data-groups') || '';
                        const firstGroup = groups.split('|||')[0] || '';
                        return firstGroup;
                    }
                    case 'accuracy': return parseFloat(row.cells[4].querySelector('.progress-value').textContent.replace('%', '')) || 0;
                    case 'score': return parseFloat(row.cells[5].textContent) || 0;
                    case 'total_questions': return parseInt(row.cells[2].textContent) || 0;
                    case 'correct': return parseInt(row.cells[3].textContent) || 0;
                }
                return 0;
            };

            const aVal = getValue(a, sortBy);
            const bVal = getValue(b, sortBy);
            return ['name', 'group'].includes(sortBy)
                ? aVal.localeCompare(bVal)
                : bVal - aVal;
        });

        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        tbody.innerHTML = '';
        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="no-data">
                        <div class="no-data-icon">üîç</div>
                        <h4 style="margin: 10px 0; color: #495057;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                        <p style="margin: 0;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞</p>
                    </td>
                </tr>
            `;
        } else {
            filtered.forEach(row => tbody.appendChild(row.cloneNode(true)));
        }
    }

    function clearFilters() {
        if (currentMode === 'groups') {
            document.getElementById('groupSearchName').value = '';
            document.getElementById('groupSortSelect').value = 'name';
        } else {
            document.getElementById('userSearchName').value = '';
            document.getElementById('userSearchGroup').value = '';
            document.getElementById('userSortSelect').value = 'name';
        }
        applyFilters();
    }

    function updateCounters() {
        const visibleUsers = document.querySelectorAll('#detailedUsersBody tr.clickable-row').length;
        const visibleGroups = document.querySelectorAll('#detailedGroupsBody tr:not(.no-data)').length;
        const hasNoDataUsers = document.querySelector('#detailedUsersBody .no-data') !== null;
        const hasNoDataGroups = document.querySelector('#detailedGroupsBody .no-data') !== null;

        document.getElementById('usersCountBadge').textContent = hasNoDataUsers ? 0 : visibleUsers;
        document.getElementById('groupsCountBadge').textContent = hasNoDataGroups ? 0 : visibleGroups;
        document.getElementById('chartCount').textContent = `(–ø–æ–∫–∞–∑–∞–Ω–æ: ${currentMode === 'users' ? visibleUsers : visibleGroups})`;
    }
</script>

{% endblock %}
{% set show_footer = False %}