import json
import openai
import os


BASE_URL = os.environ.get('BASE_URL', None)
API_KEY = "lmstudio"
MODEL_ID = "openai/gpt-oss-20b"

# Создаём клиент (подключаемся к локальному серверу)
client = openai.OpenAI(
    api_key=API_KEY,
    base_url=BASE_URL,          # здесь указывается http://<IP вашего хоста>:1234/v1
)


def prompt(message: str):
    #промт для корректного ответа от модели
    system_msg = (
        "Вы – эксперт по безопасности и мошенничеству. " 
        "Нужно оценить входящее сообщение от банка/рассылки.\n"
        "Допускайте возможность получения реальных сообщений и рассылок"
        "от банков и других организаций, имеющих в себе коды, номера и легетимные ссылки.\n"
        "Тщательно проанализируйте сообщение и дайте рекомендации для дальнейших действий."
        "Подробнее раскрыть их можете в комментарии.\n\n"
        "В качестве справочных материалов можете использовать памятку для клиентов:\n"
        "   Ежедневно каждый из нас отвечает на телефонные звонки, отправляет и \n"
        "получает электронные сообщения, смотрит видео, читает статьи, делает " 
        "покупки в интернете и другими способами всячески использует информационные ресурсы.\n" 
        "   Именно эту доступность используют злоумышленники для реализации мошеннических схем. Их главное оружие \n"
        "- доверчивость и невнимательность людей. Пользуясь ими, мошенники получают наши данные и собственность.\n"
        "   Важно проявлять осторожность при использовании интернета и сотовой связи. Злоумышленники могут выдать себя \n" 
        "за знакомых, оказавшихся в трудной ситуации, сотрудников банков или добросовестного поставщика услуг. После чего \n" 
        "они попытаются убедить вас перевести деньги, сообщить ваши персональные данные или заключить невыгодную для вас сделку. \n" 
        "Кроме этого, вы можете получать звонки с неизвестных номеров, после ответа на которые вы не услышите ничего кроме тишины. В \n" 
        "таких случаях нежелательно пытаться поддержать разговор и тем более перезванивать снова. Также вы можете получить сообщение о \n" 
        "выигрыше внушительного приза, для получения которого потребуются данные ваших счетов или перевод символической суммы. Ко всему \n" 
        "прочему опасность может поджидать вас при использовании непроверенных интернет-источников и приложений, так как они могут содержать \n"
        "вирусы или быть ловушкой аферистов. Следует отметить, что мошенники часто маскируют свои сервисы под известные и вызывающие доверие.\n"
        "   Аферисты не стоят на месте. Они используют новые технологии, совершенствуются, придумывают \n" 
        "всё более изощрённые схемы и прочее. \n"
        "   Для того чтобы не стать их жертвой нужно помнить про опасность и сформировать у себя ряд полезных привычек: \n" 
        '- Не используйте сомнительные сайты и приложения, используйте только официальный контент.\n'
        '- Не передавайте личную информацию по телефону или через интернет, не совершайте ничего, что связано с' 
        'перечислением денег, если получатель вызывает хоть малейшее сомнение.'
        '- Перед вводом конфиденциальных данных и переводом денежных средств проверяйте надежность источника.\n' 
        '- Отключите сохранение паролей, пользуйтесь сложными и разными паролями для разных сайтов.\n'
        '- Никому не говорите свой ПИН-код, логины и пароли, коды, которые приходят вам в СМС-сообщениях.\n'
        '- Проявляйте осторожность при заключении сделок через интернет или телефон.\n'
        '- Следите за файлами, которые скачиваете.\n'
        "Подводя итог, самое главное помните, что угроза может поджидать вас везде, и всегда проявляйте осторожность " 
        "при использовании современных информационных ресурсов, тогда ваша жизнь станет гораздо безопаснее.\n\n"
        "Если сообщение не содержит признаков мошенничества, не относится к банковским услугам, операциям со средствами, имуществом и конфиденциальными данными, "
        "призыву к срочным действиям и не представляет опасности для пользователя, вероятно оно не FAKE.\n"
        "Ответьте строго в JSON‑формате без лишних символов:\n"
        "{\n"
        '  "status": "REAL" | "FAKE",\n'
        '  "certainty": <float>,   // процент уверенности (0–100)\n'
        '  "text": "<рекомендации>",\n'
        '  "comment": "<доп. комментарий>" | null\n'
        "}\n"
        "Никаких дополнительных строк, не добавляйте ничего сверх JSON."
    )

    user_msg = f"Сообщение: \"{message}\""

    return [
        {"role": "system", "content": system_msg},
        {"role": "user", "content": user_msg}
    ]


def analyze_text(message: str):
    if not isinstance(message, str) or not message.strip():
        raise ValueError("message должен быть строкой")

    # Запрос к модели
    try:
        resp = client.chat.completions.create(
            model=MODEL_ID,
            messages=prompt(message),
            temperature=0.0,
            max_tokens=512,
            top_p=1.0,
            n=1,
            stream=False,
            stop=None,
        )
    except Exception:
        raise RuntimeError(f"Ошибка при обращении к модели: {Exception}") from Exception

    raw_text = resp.choices[0].message.content.strip()

    try:
        result = json.loads(raw_text)
    except json.JSONDecodeError as exc:
        raise ValueError(
            f"Модель вернула некорректный JSON: {raw_text}"
        ) from exc

    # Проверка полей
    if not isinstance(result, dict):
        raise ValueError("Ответ должен быть JSON")

    required = {"status", "certainty", "text", "comment"}
    missing   = required - result.keys()
    if missing:
        raise ValueError(f"Отсутствуют поля в ответе: {missing}")

    # Проверка типов
    if result["status"] not in ("REAL", "FAKE"):
        raise ValueError("Поле status должно быть REAL или FAKE")
    try:
        certainty = float(result["certainty"])
    except Exception:
        raise ValueError("Поле certainty должно быть числом float")
    if not isinstance(result["text"], str):
        raise ValueError("Поле text должно быть строкой")
    if result["comment"] is not None and not isinstance(result["comment"], str):
        raise ValueError("Поле comment должно быть строкой или null")


    return {
        "status": result["status"],
        "certainty": certainty,
        "text": result["text"],
        "comment": result["comment"]
    }


#?---------------------------------------------------------------------------------
def check_message(msg):
    try:
        output = analyze_text(msg)
        return(json.dumps(output, ensure_ascii=False, indent=2))
    except Exception:
        
        print(f"❌ Ошибка: {Exception}")
